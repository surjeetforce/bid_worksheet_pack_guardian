<template>
    <lightning-card>
        
        <!-- Header with title and date -->
        <template if:false={isLoading}>
    <div class="sheet-header">
        <span class="sheet-title">UNDERGROUND ESTIMATE SHEET #{sheetNumber}</span>
        <span class="sheet-date">{currentDate}</span>
    </div>
    
    <!-- Rest of content -->
</template>
        
        <div class="slds-p-around_small">
            <template if:true={isLoading}>
                <div class="slds-p-around_x-large slds-text-align_center">
                    <lightning-spinner 
                        alternative-text="Loading sheet data..." 
                        size="medium"
                        variant="brand">
                    </lightning-spinner>
                    <p class="slds-m-top_medium slds-text-body_regular">
                        Loading materials from configuration...
                    </p>
                </div>
            </template>
            <template if:false={isLoading}>
            <!-- Main estimate table with two columns -->
            <div class="estimate-table-wrapper">
                <table class="estimate-table">
                    <thead>
                        <tr>
                            <!-- Left section headers -->
                            <th class="col-description-wide">DESCRIPTION</th>
                            <th class="col-amount">AMOUNT</th>
                            <th class="col-unit">UNIT #</th>
                            <th class="col-gross">GROSS $</th>
                            
                            <th class="col-spacer"></th>
                            
                            <!-- Right section headers -->
                            <th class="col-description-wide">DESCRIPTION</th>
                            <th class="col-amount">AMOUNT</th>
                            <th class="col-unit">UNIT #</th>
                            <th class="col-gross">GROSS $</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dynamic rows using iteration -->
                        <template for:each={tableRows} for:item="row">
                            <tr key={row.id} class={row.rowClass}>
                                <!-- Left column -->
                                <td class={row.left.descriptionClass}>
                                    <template if:true={row.left.descriptionReadonly}>
                                        <div class="description-text" title={row.left.description}>
                                            {row.left.description}
                                        </div>
                                    </template>
                                    <template if:false={row.left.descriptionReadonly}>
                                        <input 
                                            type="text" 
                                            value={row.left.description}
                                            class="cell-input" 
                                            data-row={row.id}
                                            data-col="left"
                                            data-field="description"
                                            oninput={handleCellChange}
                                            readonly={row.left.descriptionReadonly} />
                                    </template>
                                </td>
                                <td class={row.left.amountClass}>
                                    <input 
                                        type="number" 
                                        value={row.left.amount}
                                        class="cell-input amount-input" 
                                        data-row={row.id}
                                        data-col="left"
                                        data-field="amount"
                                        oninput={handleCellChange}
                                        readonly={row.left.amountReadonly}
                                        step="0.01" />
                                </td>
                                <td class={row.left.unitPriceClass}>
                                    <template if:true={row.left.unitPriceReadonly}>
                                        <template if:true={row.left.unitPrice}>
                                            <template if:true={row.left.isPercentageUnitPrice}>
                                                <lightning-formatted-number
                                                    value={row.left.unitPrice}
                                                    format-style="percent-fixed"
                                                    minimum-fraction-digits="2"
                                                    maximum-fraction-digits="2">
                                                </lightning-formatted-number>
                                            </template>
                                            <template if:false={row.left.isPercentageUnitPrice}>
                                                <template if:true={row.left.isNumberUnitPrice}>
                                                    <lightning-formatted-number
                                                        value={row.left.unitPrice}
                                                        format-style="decimal"
                                                        minimum-fraction-digits="2"
                                                        maximum-fraction-digits="2">
                                                    </lightning-formatted-number>
                                                </template>
                                                <template if:false={row.left.isNumberUnitPrice}>
                                                    <lightning-formatted-number
                                                        value={row.left.unitPrice}
                                                        format-style="currency"
                                                        currency-code="USD">
                                                    </lightning-formatted-number>
                                                </template>
                                            </template>
                                        </template>
                                        <template if:false={row.left.unitPrice}>
                                            <div class="unit-price-placeholder"></div>
                                        </template>
                                    </template>
                                    <template if:false={row.left.unitPriceReadonly}>
                                        <input 
                                            type="number" 
                                            value={row.left.unitPrice}
                                            class="cell-input unit-input" 
                                            data-row={row.id}
                                            data-col="left"
                                            data-field="unitPrice"
                                            oninput={handleCellChange}
                                            step="0.01" />
                                    </template>
                                </td>
                                <td class="col-gross">
                                    <template if:true={row.left.gross}>
                                        <template if:true={row.left.isHoursGross}>
                                            <span class="hours-format">{row.left.gross} hrs</span>
                                        </template>
                                        <template if:false={row.left.isHoursGross}>
                                            <template if:true={row.left.isNumberGross}>
                                                <lightning-formatted-number
                                                    value={row.left.gross}
                                                    format-style="decimal"
                                                    minimum-fraction-digits="2"
                                                    maximum-fraction-digits="2">
                                                </lightning-formatted-number>
                                            </template>
                                            <template if:false={row.left.isNumberGross}>
                                                <lightning-formatted-number
                                                    value={row.left.gross}
                                                    format-style="currency"
                                                    currency-code="USD">
                                                </lightning-formatted-number>
                                            </template>
                                        </template>
                                    </template>
                                </td>
                                
                                <td class="col-spacer"></td>
                                
                                <!-- Right column - Handle comment rows differently -->
                                <template if:true={row.right.isCommentRow}>
                                    <!-- Comment rows span all right columns -->
                                    <td colspan="4" class="comment-cell">
                                        <textarea 
                                            class="comment-textarea" 
                                            data-row={row.id}
                                            data-col="right"
                                            data-field="description"
                                            oninput={handleCellChange}
                                            placeholder="">{row.right.description}</textarea>
                                    </td>
                                </template>
                                
                                <template if:false={row.right.isCommentRow}>
                                    <!-- Regular right column cells -->
                                    <td class={row.right.descriptionClass}>
                                        <template if:true={row.right.descriptionReadonly}>
                                            <div class="description-text" title={row.right.description}>
                                                {row.right.description}
                                            </div>
                                        </template>
                                        <template if:false={row.right.descriptionReadonly}>
                                            <input 
                                                type="text" 
                                                value={row.right.description}
                                                class="cell-input" 
                                                data-row={row.id}
                                                data-col="right"
                                                data-field="description"
                                                oninput={handleCellChange}
                                                readonly={row.right.descriptionReadonly} />
                                        </template>
                                    </td>
                                    <td class={row.right.amountClass}>
                                        <input 
                                            type="number" 
                                            value={row.right.amount}
                                            class="cell-input amount-input" 
                                            data-row={row.id}
                                            data-col="right"
                                            data-field="amount"
                                            oninput={handleCellChange}
                                            readonly={row.right.amountReadonly}
                                            step="0.01" />
                                    </td>
                                    <td class={row.right.unitPriceClass}>
                                        <template if:true={row.right.unitPriceReadonly}>
                                            <template if:true={row.right.unitPrice}>
                                                <template if:true={row.right.isPercentageUnitPrice}>
                                                    <lightning-formatted-number
                                                        value={row.right.unitPrice}
                                                        format-style="percent-fixed"
                                                        minimum-fraction-digits="2"
                                                        maximum-fraction-digits="2">
                                                    </lightning-formatted-number>
                                                </template>
                                                <template if:false={row.right.isPercentageUnitPrice}>
                                                    <template if:true={row.right.isNumberUnitPrice}>
                                                        <lightning-formatted-number
                                                            value={row.right.unitPrice}
                                                            format-style="decimal"
                                                            minimum-fraction-digits="2"
                                                            maximum-fraction-digits="2">
                                                        </lightning-formatted-number>
                                                    </template>
                                                    <template if:false={row.right.isNumberUnitPrice}>
                                                        <lightning-formatted-number
                                                            value={row.right.unitPrice}
                                                            format-style="currency"
                                                            currency-code="USD">
                                                        </lightning-formatted-number>
                                                    </template>
                                                </template>
                                            </template>
                                            <template if:false={row.right.unitPrice}>
                                                <div class="unit-price-placeholder"></div>
                                            </template>
                                        </template>
                                        <template if:false={row.right.unitPriceReadonly}>
                                            <input 
                                                type="number" 
                                                value={row.right.unitPrice}
                                                class="cell-input unit-input" 
                                                data-row={row.id}
                                                data-col="right"
                                                data-field="unitPrice"
                                                oninput={handleCellChange}
                                                step="0.01" />
                                        </template>
                                    </td>
                                    <td class="col-gross">
                                        <template if:true={row.right.gross}>
                                            <template if:true={row.right.isHoursGross}>
                                                <span class="hours-format">{row.right.gross} hrs</span>
                                            </template>
                                            <template if:false={row.right.isHoursGross}>
                                                <template if:true={row.right.isNumberGross}>
                                                    <lightning-formatted-number
                                                        value={row.right.gross}
                                                        format-style="decimal"
                                                        minimum-fraction-digits="2"
                                                        maximum-fraction-digits="2">
                                                    </lightning-formatted-number>
                                                </template>
                                                <template if:false={row.right.isNumberGross}>
                                                    <lightning-formatted-number
                                                        value={row.right.gross}
                                                        format-style="currency"
                                                        currency-code="USD">
                                                    </lightning-formatted-number>
                                                </template>
                                            </template>
                                        </template>
                                    </td>
                                </template>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
            
            <!-- Sub Total Section -->
            <div class="subtotal-section">
                <div class="subtotal-left">
                    <span class="subtotal-label">TOTAL UNDERGROUND PRICE</span>
                </div>
                <div class="subtotal-right">
                    <lightning-formatted-number
                        value={totalUndergroundPrice}
                        format-style="currency"
                        currency-code="USD"
                        class="subtotal-value">
                    </lightning-formatted-number>
                    <span class="revision-info">REV {revisionDate}</span>
                </div>
            </div>
            </template>
            
        </div>
        
    </lightning-card>
</template>